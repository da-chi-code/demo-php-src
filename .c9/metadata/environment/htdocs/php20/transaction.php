{"filter":false,"title":"transaction.php","tooltip":"/htdocs/php20/transaction.php","undoManager":{"mark":15,"position":15,"stack":[[{"start":{"row":0,"column":0},"end":{"row":119,"column":7},"action":"insert","lines":["<?php","/**","* トランザクション処理を理解するためのサンプルプログラムです。","* あくまで理解を助けるためのプログラムなので、トランザクション関連以外の処理はかなり省いています。","*/","// MySQL接続情報","$host   = 'localhost'; // データベースのホスト名又はIPアドレス","$user   = 'username';  // MySQLのユーザ名","$passwd = 'passwd';    // MySQLのパスワード","$dbname = 'dbname';    // データベース名","$customer_id = 1;          // 例題のため顧客は1に固定","$payment = 'クレジット'; // 例題のため購入方法はクレジットに固定する","$quantity = 1;          // 例題のため数量は1に固定","$goods_list  = [];","$err_msg = [];","// コネクション取得","if ($link = mysqli_connect($host, $user, $passwd, $dbname)) {"," ","   // 文字コードセット","   mysqli_set_charset($link, 'UTF8');","   // 購入処理","   if( $_SERVER['REQUEST_METHOD'] === 'POST' ) {","       // 現在時刻を取得","       $date = date('Y-m-d H:i:s');","       // 商品IDを取得","       $goods_id = (int) $_POST['goods_id'];","       // 更新系の処理を行う前にトランザクション開始(オートコミットをオフ）","       mysqli_autocommit($link, false);","       /**","        * 発注情報を挿入","        */","       // 挿入情報をまとめる","       $data = [","           'customer_id' => $customer_id,","           'order_date'  => $date,","           'payment' => $payment","       ];","       // insertのSQL","       $sql = 'INSERT INTO order_table (customer_id, order_date, payment) VALUES(\\'' . implode('\\',\\'', $data) . '\\')';","       // insertを実行する","       if (mysqli_query($link, $sql) === TRUE) {"," ","           // A_Iを取得","           $order_id = mysqli_insert_id($link);","           /**","            * 発注詳細情報を挿入","            */","           // 挿入情報をまとめる","           $data = [","               'order_id' => $order_id,","               'goods_id' => $goods_id,","               'quantity' => $quantity","           ];","           // 注文詳細情報をinsertする","           $sql = 'INSERT INTO order_detail_table (order_id, goods_id, quantity) VALUES(\\'' . implode('\\',\\'', $data) . '\\')';","           // insertを実行する","           if (mysqli_query($link, $sql) !== TRUE) {","               $err_msg[] = 'order_detail_table: insertエラー:' . $sql;","           }","       } else {","           $err_msg[] = 'order_table: insertエラー:' . $sql;","       }","       // トランザクション成否判定","       if (count($err_msg) === 0) {","           // 処理確定","           mysqli_commit($link);","       } else {","           // 処理取消","           mysqli_rollback($link);","       }","   }","   /**","    * 商品情報を取得","    */","   // SQL","   $sql = 'SELECT goods_id, goods_name, price FROM goods_table';","   // クエリ実行","   if ($result = mysqli_query($link, $sql)) {","       $i = 0;","       while ($row = mysqli_fetch_assoc($result)) {","           $goods_list[$i]['goods_id']   = htmlspecialchars($row['goods_id'],   ENT_QUOTES, 'UTF-8');","           $goods_list[$i]['goods_name'] = htmlspecialchars($row['goods_name'], ENT_QUOTES, 'UTF-8');","           $goods_list[$i]['price']   = htmlspecialchars($row['price'],   ENT_QUOTES, 'UTF-8');","           $i++;","       }","   } else {","       $err_msg[] = 'SQL失敗:' . $sql;","   }","   mysqli_free_result($result);","   mysqli_close($link);","} else {","   $err_msg[] = 'error: ' . mysqli_connect_error();","}","//var_dump($err_msg); // エラーの確認が必要ならばコメントを外す","?>","<!DOCTYPE HTML>","<html lang=\"ja\">","<head>","   <meta charset=\"UTF-8\">","   <title>トランザクションサンプル</title>","</head>","<body>","   <section>","       <h1>商品購入</h1>","       <ul>","<?php foreach ($goods_list as $goods) { ?>","           <li>","               <span><?php print $goods['goods_name']; ?></span>","               <span><?php print $goods['price']; ?>円</span>","               <form method=\"post\">","                   <input type=\"hidden\" name=\"goods_id\" value=\"<?php print $goods['goods_id']; ?>\">","                   <input type=\"submit\" value=\"購入する\">","               </form>","           </li>","<?php } ?>","       </ul>","       <p>※サンプルのため購入は1商品 & 1個に固定</p>","   </section>","</body>","</html>"],"id":1}],[{"start":{"row":6,"column":19},"end":{"row":6,"column":20},"action":"remove","lines":["t"],"id":2},{"start":{"row":6,"column":18},"end":{"row":6,"column":19},"action":"remove","lines":["s"]},{"start":{"row":6,"column":17},"end":{"row":6,"column":18},"action":"remove","lines":["o"]},{"start":{"row":6,"column":16},"end":{"row":6,"column":17},"action":"remove","lines":["h"]},{"start":{"row":6,"column":15},"end":{"row":6,"column":16},"action":"remove","lines":["l"]},{"start":{"row":6,"column":14},"end":{"row":6,"column":15},"action":"remove","lines":["a"]},{"start":{"row":6,"column":13},"end":{"row":6,"column":14},"action":"remove","lines":["c"]},{"start":{"row":6,"column":12},"end":{"row":6,"column":13},"action":"remove","lines":["o"]},{"start":{"row":6,"column":11},"end":{"row":6,"column":12},"action":"remove","lines":["l"]}],[{"start":{"row":6,"column":11},"end":{"row":6,"column":12},"action":"insert","lines":["c"],"id":3},{"start":{"row":6,"column":12},"end":{"row":6,"column":13},"action":"insert","lines":["o"]},{"start":{"row":6,"column":13},"end":{"row":6,"column":14},"action":"insert","lines":["d"]},{"start":{"row":6,"column":14},"end":{"row":6,"column":15},"action":"insert","lines":["e"]},{"start":{"row":6,"column":15},"end":{"row":6,"column":16},"action":"insert","lines":["c"]},{"start":{"row":6,"column":16},"end":{"row":6,"column":17},"action":"insert","lines":["a"]}],[{"start":{"row":6,"column":17},"end":{"row":6,"column":18},"action":"insert","lines":["m"],"id":4},{"start":{"row":6,"column":18},"end":{"row":6,"column":19},"action":"insert","lines":["p"]},{"start":{"row":6,"column":19},"end":{"row":6,"column":20},"action":"insert","lines":["3"]},{"start":{"row":6,"column":20},"end":{"row":6,"column":21},"action":"insert","lines":["3"]},{"start":{"row":6,"column":21},"end":{"row":6,"column":22},"action":"insert","lines":["7"]}],[{"start":{"row":6,"column":22},"end":{"row":6,"column":23},"action":"insert","lines":["8"],"id":5},{"start":{"row":6,"column":23},"end":{"row":6,"column":24},"action":"insert","lines":["4"]},{"start":{"row":6,"column":24},"end":{"row":6,"column":25},"action":"insert","lines":["8"]}],[{"start":{"row":6,"column":21},"end":{"row":6,"column":22},"action":"remove","lines":["7"],"id":6}],[{"start":{"row":7,"column":12},"end":{"row":7,"column":19},"action":"remove","lines":["sername"],"id":7},{"start":{"row":7,"column":12},"end":{"row":7,"column":19},"action":"insert","lines":["sername"]}],[{"start":{"row":7,"column":11},"end":{"row":7,"column":19},"action":"remove","lines":["username"],"id":8},{"start":{"row":7,"column":11},"end":{"row":7,"column":24},"action":"insert","lines":["codecamp33848"]}],[{"start":{"row":8,"column":11},"end":{"row":8,"column":17},"action":"remove","lines":["passwd"],"id":9},{"start":{"row":8,"column":11},"end":{"row":8,"column":24},"action":"insert","lines":["codecamp33848"]}],[{"start":{"row":9,"column":16},"end":{"row":9,"column":17},"action":"remove","lines":["e"],"id":10},{"start":{"row":9,"column":15},"end":{"row":9,"column":16},"action":"remove","lines":["m"]},{"start":{"row":9,"column":14},"end":{"row":9,"column":15},"action":"remove","lines":["a"]},{"start":{"row":9,"column":13},"end":{"row":9,"column":14},"action":"remove","lines":["n"]},{"start":{"row":9,"column":12},"end":{"row":9,"column":13},"action":"remove","lines":["b"]},{"start":{"row":9,"column":11},"end":{"row":9,"column":12},"action":"remove","lines":["d"]}],[{"start":{"row":9,"column":11},"end":{"row":9,"column":12},"action":"insert","lines":["o"],"id":11},{"start":{"row":9,"column":12},"end":{"row":9,"column":13},"action":"insert","lines":["r"]},{"start":{"row":9,"column":13},"end":{"row":9,"column":14},"action":"insert","lines":["d"]},{"start":{"row":9,"column":14},"end":{"row":9,"column":15},"action":"insert","lines":["e"]},{"start":{"row":9,"column":15},"end":{"row":9,"column":16},"action":"insert","lines":["r"]},{"start":{"row":9,"column":16},"end":{"row":9,"column":17},"action":"insert","lines":["_"]}],[{"start":{"row":9,"column":17},"end":{"row":9,"column":18},"action":"insert","lines":["t"],"id":12},{"start":{"row":9,"column":18},"end":{"row":9,"column":19},"action":"insert","lines":["a"]},{"start":{"row":9,"column":19},"end":{"row":9,"column":20},"action":"insert","lines":["b"]},{"start":{"row":9,"column":20},"end":{"row":9,"column":21},"action":"insert","lines":["l"]},{"start":{"row":9,"column":21},"end":{"row":9,"column":22},"action":"insert","lines":["e"]}],[{"start":{"row":6,"column":23},"end":{"row":6,"column":24},"action":"remove","lines":["8"],"id":13},{"start":{"row":6,"column":22},"end":{"row":6,"column":23},"action":"remove","lines":["4"]},{"start":{"row":6,"column":21},"end":{"row":6,"column":22},"action":"remove","lines":["8"]},{"start":{"row":6,"column":20},"end":{"row":6,"column":21},"action":"remove","lines":["3"]},{"start":{"row":6,"column":19},"end":{"row":6,"column":20},"action":"remove","lines":["3"]},{"start":{"row":6,"column":18},"end":{"row":6,"column":19},"action":"remove","lines":["p"]},{"start":{"row":6,"column":17},"end":{"row":6,"column":18},"action":"remove","lines":["m"]},{"start":{"row":6,"column":16},"end":{"row":6,"column":17},"action":"remove","lines":["a"]},{"start":{"row":6,"column":15},"end":{"row":6,"column":16},"action":"remove","lines":["c"]},{"start":{"row":6,"column":14},"end":{"row":6,"column":15},"action":"remove","lines":["e"]},{"start":{"row":6,"column":13},"end":{"row":6,"column":14},"action":"remove","lines":["d"]},{"start":{"row":6,"column":12},"end":{"row":6,"column":13},"action":"remove","lines":["o"]},{"start":{"row":6,"column":11},"end":{"row":6,"column":12},"action":"remove","lines":["c"]}],[{"start":{"row":6,"column":11},"end":{"row":6,"column":12},"action":"insert","lines":["l"],"id":14},{"start":{"row":6,"column":12},"end":{"row":6,"column":13},"action":"insert","lines":["o"]},{"start":{"row":6,"column":13},"end":{"row":6,"column":14},"action":"insert","lines":["c"]},{"start":{"row":6,"column":14},"end":{"row":6,"column":15},"action":"insert","lines":["a"]},{"start":{"row":6,"column":15},"end":{"row":6,"column":16},"action":"insert","lines":["l"]},{"start":{"row":6,"column":16},"end":{"row":6,"column":17},"action":"insert","lines":["h"]}],[{"start":{"row":6,"column":17},"end":{"row":6,"column":18},"action":"insert","lines":["o"],"id":15},{"start":{"row":6,"column":18},"end":{"row":6,"column":19},"action":"insert","lines":["s"]},{"start":{"row":6,"column":19},"end":{"row":6,"column":20},"action":"insert","lines":["t"]}],[{"start":{"row":9,"column":11},"end":{"row":9,"column":22},"action":"remove","lines":["order_table"],"id":16},{"start":{"row":9,"column":11},"end":{"row":9,"column":24},"action":"insert","lines":["codecamp33848"]}]]},"ace":{"folds":[],"scrolltop":1345.5,"scrollleft":0,"selection":{"start":{"row":91,"column":51},"end":{"row":92,"column":1},"isBackwards":true},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":282,"mode":"ace/mode/php"}},"timestamp":1596451067027,"hash":"438a146e5e41acdac0914fae4644b5bd5dfc6d26"}