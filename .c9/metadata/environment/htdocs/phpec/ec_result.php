{"filter":false,"title":"ec_result.php","tooltip":"/htdocs/phpec/ec_result.php","undoManager":{"mark":6,"position":6,"stack":[[{"start":{"row":1,"column":0},"end":{"row":43,"column":56},"action":"remove","lines":["// 設定ファイル読み込み","require_once '../../include/conf/const_drink.php';","// 関数ファイルみ込み","require_once '../../include/model/model_drink_result.php';","//変数定義","//変数定義","$money = '';","$drink_id = '';","$err_msgs = [];","$drink_lists = [];","$update_stock = '';","$change = '';","$date = date('Y-m-d H:i:s');","//接続確認","$link = get_db_connect();","$request_method = get_request_method();","if ($request_method === 'POST') {","    //投入金額及び商品選択のエラーチェック","    $money = get_post_data('money');","    $drink_id = get_post_data('drink_id');","    if (check_name($money) !== '') {","        $err_msgs[] = check_price($money);","    }","    if (check_name($drink_id) !== '') {","        $err_msgs[] = check_price($drink_id);","    }","    //エラーがなければ選択商品の各データを取得する処理","    if (count($err_msgs) === 0) {","        $drink_lists = get_drink_data($link);","        $drink_lists = entity_assoc_array($drink_lists);","        if (check_purchase($money, $drink_lists) !== '') {","            $err_msgs[] = array_merge($err_msgs, check_purchase($money, $drink_lists));","        }","        if (update_inventory_purchase_history($link, $update_stock, $drink_lists, $date, $drink_id) !== '') {","            $err_msgs[] = array_merge($err_msgs, update_inventory_purchase_history($link, $update_stock, $drink_lists, $date, $drink_id));","        }","        if (count($err_msgs) === 0) {","            $change = change_process($money, $drink_lists);","        }","    }","    close_db_connect($link);","}","include_once '../../include/view/view_drink_result.php';"],"id":1},{"start":{"row":1,"column":0},"end":{"row":122,"column":7},"action":"insert","lines":["<?php","// MySQL接続情報","$host   = 'localhost'; // データベースのホスト名又はIPアドレス","$user   = 'codecamp33848';  // MySQLのユーザ名","$passwd = 'codecamp33848';    // MySQLのパスワード","$dbname = 'codecamp33848';    // データベース名","//変数定義","$money = '';","$drink_id = '';","$err_msgs = [];","$drink_lists = [];","$update_stock = '';","$change = '';","$date = date('Y-m-d H:i:s');","//接続確認","if ($link = mysqli_connect($host, $user, $passwd, $dbname)) {","    mysqli_set_charset($link, 'UTF8');","    if($_SERVER['REQUEST_METHOD'] === 'POST'){","        //投入金額及び商品選択のエラーチェック","        if (isset($_POST['money']) === TRUE){","            $money = $_POST['money'];","            if(strlen($money) <> mb_strlen($money)){","                $money = mb_convert_kana($_POST['money'],'n');","                if(ctype_digit($money)){","                    $money = intval($money);","                }","            }","            else{","                if(ctype_digit($money)){","                    $money = intval($money);","                }","            }","                ","        }","        if (isset($_POST['drink_id']) === TRUE){","            $drink_id = $_POST['drink_id'];","        }","        if (empty($money) === TRUE) {","            $err_msgs[] = 'お金を投入してください';","        }","        elseif(is_int($money) === false || $money < 0){","            $err_msgs[] = 'お金は０以上の整数で入力してください';","        }","        if (empty($drink_id) === TRUE) {","            $err_msgs[] = '商品を選択してください';","        }","        //エラーがなければ選択商品の各データを取得する処理","        if(count($err_msgs) === 0){","            //トランザクション開始","            mysqli_autocommit($link, false);","            $sql = 'SELECT drink_list.drink_id,drink_list.drink_name,drink_list.price,drink_list.create_at,drink_list.status,drink_list.display,inventory_table.stock FROM drink_list LEFT JOIN inventory_table ON inventory_table.drink_id = drink_list.drink_id WHERE drink_list.drink_id ='.$drink_id;","            if($result = mysqli_query($link, $sql)){","                $drink_lists = mysqli_fetch_assoc($result);","                if($money < $drink_lists['price'] ){","                    $err_msgs[]='お金がたりません';","                }","                if($drink_lists['stock'] === 0){","                    $err_msgs[]='商品の在庫がありません';","                }","                if($drink_lists['status'] === '0'){","                    $err_msgs[]='非公開の商品です';","                }","            }","            else{","                $err_msgs[]='選択できませんでした';","            }","            //在庫を１つ減らす処理","            $update_stock = $drink_lists['stock'] - 1;","            if($drink_lists['stock'] <= 0){","                $err_msgs[]='商品の在庫がありません';","            }","            $sql = 'UPDATE inventory_table SET stock =\\''.$update_stock.'\\',update_at =\\''.$date.'\\'WHERE drink_id =\\''.$drink_id.'\\'';","            if(mysqli_query($link, $sql) === false){","                $err_msgs[]='在庫を減らせませんでした';","            }","            //購入履歴を追加する処理","            $sql = 'INSERT INTO purchase_history(drink_id,purchase_at) VALUES(\\''.$drink_id.'\\',\\''.$date.'\\')';","            if(mysqli_query($link, $sql) === false){","                $err_msgs[]='購入履歴を追加できませんでした';","            }","            if (count($err_msgs) === 0) {","                // 処理確定","                mysqli_commit($link);","                //おつり処理","                if($money - $drink_lists['price'] >= 0){","                    $change = $money - $drink_lists['price'];","                }","                else{","                    $change = 0;","                }","            } else {","                // 処理取消","                mysqli_rollback($link);","            }","            mysqli_free_result($result);","            mysqli_close($link);","        }","    }","}","else {","   print 'DB接続失敗';","} ","?>","<!DOCTYPE html>","<html lang=\"ja\">","<head>","    <meta charset=\"utf-8\">","    <title>自動販売機結果</title>","</head>","<body>","    <h1>自動販売機結果</h1>","<?php foreach ($err_msgs as $err_msg) { ?>","        <p><?php print $err_msg;?></p>","<?php } ?>","<?php if(count($err_msgs) === 0){?>","        <img src=<?php print './image/'.str_replace(' ','',str_replace('-','',str_replace(':','',$drink_lists['create_at']))).$drink_lists['display'];?>>","        <p>がしゃん！【<?php print htmlspecialchars($drink_lists['drink_name'],ENT_QUOTES,'UTF-8')?>】が買えました！</p>","        <p>おつりは【<?php print $change?>円】です</p>","<?php }?>","    <footer><a href=\"index.php\">戻る</a></footer>","</body>","</html>"]}],[{"start":{"row":104,"column":0},"end":{"row":122,"column":7},"action":"remove","lines":["<!DOCTYPE html>","<html lang=\"ja\">","<head>","    <meta charset=\"utf-8\">","    <title>自動販売機結果</title>","</head>","<body>","    <h1>自動販売機結果</h1>","<?php foreach ($err_msgs as $err_msg) { ?>","        <p><?php print $err_msg;?></p>","<?php } ?>","<?php if(count($err_msgs) === 0){?>","        <img src=<?php print './image/'.str_replace(' ','',str_replace('-','',str_replace(':','',$drink_lists['create_at']))).$drink_lists['display'];?>>","        <p>がしゃん！【<?php print htmlspecialchars($drink_lists['drink_name'],ENT_QUOTES,'UTF-8')?>】が買えました！</p>","        <p>おつりは【<?php print $change?>円】です</p>","<?php }?>","    <footer><a href=\"index.php\">戻る</a></footer>","</body>","</html>"],"id":2},{"start":{"row":103,"column":2},"end":{"row":104,"column":0},"action":"remove","lines":["",""]}],[{"start":{"row":0,"column":0},"end":{"row":103,"column":2},"action":"remove","lines":["<?php","<?php","// MySQL接続情報","$host   = 'localhost'; // データベースのホスト名又はIPアドレス","$user   = 'codecamp33848';  // MySQLのユーザ名","$passwd = 'codecamp33848';    // MySQLのパスワード","$dbname = 'codecamp33848';    // データベース名","//変数定義","$money = '';","$drink_id = '';","$err_msgs = [];","$drink_lists = [];","$update_stock = '';","$change = '';","$date = date('Y-m-d H:i:s');","//接続確認","if ($link = mysqli_connect($host, $user, $passwd, $dbname)) {","    mysqli_set_charset($link, 'UTF8');","    if($_SERVER['REQUEST_METHOD'] === 'POST'){","        //投入金額及び商品選択のエラーチェック","        if (isset($_POST['money']) === TRUE){","            $money = $_POST['money'];","            if(strlen($money) <> mb_strlen($money)){","                $money = mb_convert_kana($_POST['money'],'n');","                if(ctype_digit($money)){","                    $money = intval($money);","                }","            }","            else{","                if(ctype_digit($money)){","                    $money = intval($money);","                }","            }","                ","        }","        if (isset($_POST['drink_id']) === TRUE){","            $drink_id = $_POST['drink_id'];","        }","        if (empty($money) === TRUE) {","            $err_msgs[] = 'お金を投入してください';","        }","        elseif(is_int($money) === false || $money < 0){","            $err_msgs[] = 'お金は０以上の整数で入力してください';","        }","        if (empty($drink_id) === TRUE) {","            $err_msgs[] = '商品を選択してください';","        }","        //エラーがなければ選択商品の各データを取得する処理","        if(count($err_msgs) === 0){","            //トランザクション開始","            mysqli_autocommit($link, false);","            $sql = 'SELECT drink_list.drink_id,drink_list.drink_name,drink_list.price,drink_list.create_at,drink_list.status,drink_list.display,inventory_table.stock FROM drink_list LEFT JOIN inventory_table ON inventory_table.drink_id = drink_list.drink_id WHERE drink_list.drink_id ='.$drink_id;","            if($result = mysqli_query($link, $sql)){","                $drink_lists = mysqli_fetch_assoc($result);","                if($money < $drink_lists['price'] ){","                    $err_msgs[]='お金がたりません';","                }","                if($drink_lists['stock'] === 0){","                    $err_msgs[]='商品の在庫がありません';","                }","                if($drink_lists['status'] === '0'){","                    $err_msgs[]='非公開の商品です';","                }","            }","            else{","                $err_msgs[]='選択できませんでした';","            }","            //在庫を１つ減らす処理","            $update_stock = $drink_lists['stock'] - 1;","            if($drink_lists['stock'] <= 0){","                $err_msgs[]='商品の在庫がありません';","            }","            $sql = 'UPDATE inventory_table SET stock =\\''.$update_stock.'\\',update_at =\\''.$date.'\\'WHERE drink_id =\\''.$drink_id.'\\'';","            if(mysqli_query($link, $sql) === false){","                $err_msgs[]='在庫を減らせませんでした';","            }","            //購入履歴を追加する処理","            $sql = 'INSERT INTO purchase_history(drink_id,purchase_at) VALUES(\\''.$drink_id.'\\',\\''.$date.'\\')';","            if(mysqli_query($link, $sql) === false){","                $err_msgs[]='購入履歴を追加できませんでした';","            }","            if (count($err_msgs) === 0) {","                // 処理確定","                mysqli_commit($link);","                //おつり処理","                if($money - $drink_lists['price'] >= 0){","                    $change = $money - $drink_lists['price'];","                }","                else{","                    $change = 0;","                }","            } else {","                // 処理取消","                mysqli_rollback($link);","            }","            mysqli_free_result($result);","            mysqli_close($link);","        }","    }","}","else {","   print 'DB接続失敗';","} ","?>"],"id":3},{"start":{"row":0,"column":0},"end":{"row":30,"column":50},"action":"insert","lines":["<?php","// 設定ファイル読み込み","require_once '../../include/conf/ec_const.php';","// 関数ファイル読み込み","require_once '../../include/model/ec_function.php';","require_once '../../include/model/model_item.php';","require_once '../../include/model/model_cart.php';","//変数定義","//リダイレクト、管理者でなければホームページ、その他はログインページへ","session_start();","$_SESSION['err_msgs'] = [];","if(!isset($_SESSION['user_id'])){","    redirect_login();","}","$link = get_db_connect();","$request_method = get_request_method();","if($request_method === 'POST'){","    if($_POST['sql_kind'] === 'delete_cart'){","        delete_cart($link,$_POST);","    }","    if($_POST['sql_kind'] === 'change_cart'){","        validation_item($_POST);","        change_amount($link,$_POST);","    }","}","$cart_lists = get_cart_list($link);","close_db_connect($link);","$sum = sum_cart($cart_lists);","$err_msgs = $_SESSION['err_msgs'];","unset($_SESSION['err_msgs']);","include_once '../../include/view/view_ec_top.php';"]}],[{"start":{"row":30,"column":43},"end":{"row":30,"column":44},"action":"remove","lines":["p"],"id":4},{"start":{"row":30,"column":42},"end":{"row":30,"column":43},"action":"remove","lines":["o"]},{"start":{"row":30,"column":41},"end":{"row":30,"column":42},"action":"remove","lines":["t"]}],[{"start":{"row":30,"column":41},"end":{"row":30,"column":42},"action":"insert","lines":["r"],"id":5},{"start":{"row":30,"column":42},"end":{"row":30,"column":43},"action":"insert","lines":["e"]},{"start":{"row":30,"column":43},"end":{"row":30,"column":44},"action":"insert","lines":["s"]},{"start":{"row":30,"column":44},"end":{"row":30,"column":45},"action":"insert","lines":["u"]},{"start":{"row":30,"column":45},"end":{"row":30,"column":46},"action":"insert","lines":["l"]},{"start":{"row":30,"column":46},"end":{"row":30,"column":47},"action":"insert","lines":["r"]}],[{"start":{"row":30,"column":46},"end":{"row":30,"column":47},"action":"remove","lines":["r"],"id":6}],[{"start":{"row":30,"column":46},"end":{"row":30,"column":47},"action":"insert","lines":["t"],"id":7}]]},"ace":{"folds":[],"scrolltop":287.5,"scrollleft":0,"selection":{"start":{"row":30,"column":47},"end":{"row":30,"column":47},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":0},"timestamp":1600560613388,"hash":"9130aeacecbd540b1be36fe36544468ff7f45313"}