{"filter":false,"title":"session.md","tooltip":"/session.md","undoManager":{"mark":1,"position":1,"stack":[[{"start":{"row":0,"column":0},"end":{"row":105,"column":3},"action":"insert","lines":["---","tags: 'php'","---","# PHPのセッションの仕組みと扱い方","","## セッションとは？","","セッションでは、キーと値のセットが複数集まった配列のようなデータを管理することができます。","","$_SESSIONというスーパーグローバル変数を使用します。","","以下のような書き方で、キーと値を指定してデータを登録できます。","","```php","$_SESSION['key'] = 'value';","```","","一見すると普通の配列と何ら変わりありません。","実際、$_SESSION変数は普通の配列です。","","ただ、セッションではこの配列の内容を文字列としてファイルに記録（セーブ）して、あとからいつでも読み込んで配列に戻すことができます。","","「あとから」と表現しましたが、これはブラウザを閉じたり、一旦別のページに移動したりといった処理を行って前回のプログラムが完全に実行終了したあとからでも、再びそのプログラムにアクセスすると前の状態を保っているという状態を指します。","","誤解を恐れずに、ひとことで表すなら、「配列変数のセーブ機能」がセッションです。","","ただ、セーブといっても少しだけ特徴があって、それはブラウザを使ってPHPにアクセスしてきたユーザーを個別に認識して、そのユーザーにとっての処理状態を配列変数にセーブすることが出来るのです。","","つまり、ユーザーごとにセーブされている内容が異なります。","","## セッションの仕組み","","セッションは通常、サーバーのマシン内の決められたディレクトリ（フォルダ）内にファイルとして保存されます。このファイルは一人のユーザー専用のファイルとして扱われます。","そして、そのファイルの名前にはセッションIDと呼ばれる英数記号の羅列の文字列が使われます。","","サーバー内のセッションディレクトリ内のイメージ","","|ファイル名|","|----|","|fkh8hoa9jmt6sfeuk5rgs1p4d8|","|dutfuu7cr5ho15ad3vjqjibdji|","|16qd5b09sbvqirf5d1tfg9jjsh|","|or7nm40uf7un4dlgst9bjjdph1|","|...|","","それとは別に、セッション名と呼ばれるものがあってこれはデフォルトではPHPSESSIDという文字列が設定されています。（session_name関数を使用するとPHPSESSID以外の名前に変更も可能）","","このPHPSESSIDをキーとして、セッションID文字列を値としたクッキ���を発行します。","","ユーザーのブラウザに保存されたクッキー情報のイメージ","","|クッキー名|クッキー値|","|--------|--------|","|PHPSESSID|fkh8hoa9jmt6sfeuk5rgs1p4d8|","","これにより、ユーザーがアクセスするとクッキーからセッションIDを知ることが出来るため、","そのセッションIDから、サーバー上に保存されているセッションファイルの中身をロードします。","","このようにして、セッションに保存されたデータを読み込むことができるのですが、","これらの一連の処理はPHPの、session_start()という関数を呼ぶだけで全部やってくれます。","","あとは、セッションに記録したい情報があれば、","","```php","$_SESSION['key'] = 'value';","```","","のように、$_SESSION配列にデータをセットするだけでプログラム終了時に自動でセッションファイルにセーブ（記録）されます。","","## session_start関数がやっていること","","- $_COOKIE['PHPSESSID']に値が入っているかどうかをチェックする。","- 値が入っていれば、その値と同じファイル名のファイルがセッションディレクトリに存在するかどうかをチェックする","","この2段階のチェックによって、ファイルの存在まで確認できた場合はそのユーザー専用のセッション情報があるということなので、それを$_SESSION配列にロード（読み込み）する","","確認できなかった場合は、そのユーザー用のセッション情報が存在しないので、新しいセッションIDを発行してそのセッションIDと同名のファイルをセッションディレクトリに作成し、ユーザーのブラウザのクッキー情報にセッションIDを記録させる指示を出す。","","ざっくりとこれらの手続きを、session_start()関数を実行するだけで行っています。","","## セッション情報を破棄する方法（ログアウト処理にも有効）","","```php","$session_name = session_name();","","// セッション配列を空にする","$_SESSION = [];","","if (isset($_COOKIE[$session_name]) === true) {","    $params = session_get_cookie_params();","","    // ブラウザのクッキーに保存している情報を空にしつつ、有効期限を過去の日付にして破棄を促す","    setcookie(","        $session_name,","        '',","        time() - 42000,","        $params['path'],","        $params['domain'],","        $params['secure'],","        $params['httponly']","    );","}","","// セッションに関連付いた情報をすべて廃棄する（セッションファイルなど）","session_destroy();","```"],"id":1}],[{"start":{"row":0,"column":0},"end":{"row":2,"column":3},"action":"remove","lines":["---","tags: 'php'","---"],"id":2},{"start":{"row":0,"column":0},"end":{"row":1,"column":0},"action":"remove","lines":["",""]}]]},"ace":{"folds":[],"scrolltop":0,"scrollleft":0,"selection":{"start":{"row":1,"column":0},"end":{"row":1,"column":0},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":0},"timestamp":1599220882084,"hash":"59ccd059f4c70d07ed1b376c8263a16ffbe98802"}